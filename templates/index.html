<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIN Lookup</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#111">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" href="/static/icon-512.png">
  <link rel="apple-touch-icon" href="/static/icon-512.png">

  <link rel="stylesheet" href="/static/style.css" />

  <!-- Google Maps -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap">
  </script>
</head>
<body>
  <div id="loader">
    <div class="spinner"></div>
    <p>Loading map...</p>
  </div>

  <div class="container hidden">
    <div id="display">----</div>
    <div id="keypad"></div>
    <button id="submit">Submit</button>
    <div id="result"></div>
    <div id="map"></div>
  </div>

  <script>
    let map, marker;

    // --- Initialize Google Map ---
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 43.7, lng: -79.4 },
        zoom: 10,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#212121" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
          { featureType: "poi", stylers: [{ visibility: "off" }] },
          { featureType: "road", stylers: [{ color: "#383838" }] },
          { featureType: "water", stylers: [{ color: "#000000" }] }
        ],
      });

      // Hide loader when map is ready
      document.getElementById("loader").style.display = "none";
      document.querySelector(".container").classList.remove("hidden");
    }

    // --- UI Logic ---
    const display = document.getElementById('display');
    const keypad = document.getElementById('keypad');
    const result = document.getElementById('result');
    const submitBtn = document.getElementById('submit');

    const keys = ['1','2','3','4','5','6','7','8','9','0','C'];
    keys.forEach(k => {
      const btn = document.createElement('button');
      btn.textContent = k;
      btn.onclick = () => {
        if (k === 'C') {
          display.textContent = '----';
          result.textContent = '';
        } else if (display.textContent.replace(/-/g,'').length < 4) {
          display.textContent = (display.textContent + k)
            .replace(/-/g,'')
            .slice(-4)
            .padStart(4,'-');
        }
      };
      keypad.appendChild(btn);
    });

    submitBtn.onclick = async () => {
      const pin = display.textContent.replace(/-/g,'');
      if (pin.length !== 4) {
        result.textContent = 'Enter a 4-digit PIN';
        return;
      }
      result.textContent = 'Looking up...';
      const res = await fetch('/lookup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pin})
      });
      const data = await res.json();
      if (!res.ok || !data.found) {
        result.textContent = 'PIN not found';
        return;
      }

      const addr = data.address;
      result.textContent = addr;

      // --- Geocode address to coordinates ---
      const geoRes = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(addr)}&key={{ google_api_key }}`);
      const geoData = await geoRes.json();
      if (geoData.results && geoData.results.length > 0) {
        const { lat, lng } = geoData.results[0].geometry.location;
        map.setCenter({ lat, lng });
        map.setZoom(15);
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: { lat, lng }, map });
      }
    };

    // --- Register Service Worker for PWA ---
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/static/service-worker.js")
        .then(() => console.log("âœ… Service Worker registered"))
        .catch(err => console.error("SW registration failed", err));
    }
  </script>
</body>
</html>
