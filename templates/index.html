<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIN Lookup</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#111">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" href="/static/icon-512.png">
  <link rel="apple-touch-icon" href="/static/icon-512.png">

  <link rel="stylesheet" href="/static/style.css" />

  <script>
    // --- Make initMap global BEFORE Google Maps loads ---
    let map, marker, lastAddress = null, lastCoords = null, currentPos = null;

    window.initMap = function() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 43.7, lng: -79.4 },
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#212121" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
          { featureType: "poi", stylers: [{ visibility: "off" }] },
          { featureType: "road", stylers: [{ color: "#383838" }] },
          { featureType: "water", stylers: [{ color: "#000000" }] }
        ],
      });

      // Geolocation
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            map.setCenter(currentPos);
            map.setZoom(14);
          },
          err => console.warn("Geolocation denied or failed", err)
        );
      }

      document.getElementById("loader").style.display = "none";
      document.querySelector(".app").classList.remove("hidden");
    }
  </script>

  <!-- Google Maps script loaded after initMap is defined -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap">
  </script>
</head>
<body>
  <div id="loader">
    <div class="spinner"></div>
    <p>Loading map...</p>
  </div>

  <div class="app hidden">
    <div id="map"></div>

    <div class="bottom-panel">
      <div id="display">----</div>
      <div id="keypad"></div>
      <button id="submit">Submit</button>
      <div id="result"></div>
      <button id="directions" class="hidden">Get Directions</button>
    </div>
  </div>

  <script>
    const display = document.getElementById('display');
    const keypad = document.getElementById('keypad');
    const result = document.getElementById('result');
    const submitBtn = document.getElementById('submit');
    const dirBtn = document.getElementById('directions');

    // --- Keypad ---
    const keys = ['1','2','3','4','5','6','7','8','9','0','C'];
    keys.forEach(k => {
      const btn = document.createElement('button');
      btn.textContent = k;
      btn.onclick = () => {
        if (k === 'C') {
          display.textContent = '----';
          result.textContent = '';
          dirBtn.classList.add('hidden');
        } else if (display.textContent.replace(/-/g,'').length < 4) {
          display.textContent = (display.textContent + k)
            .replace(/-/g,'')
            .slice(-4)
            .padStart(4,'-');
        }
        adjustMapHeight(); // dynamic map resize on input
      };
      keypad.appendChild(btn);
    });

    // --- Lookup ---
    submitBtn.onclick = async () => {
      const pin = display.textContent.replace(/-/g,'');
      if (pin.length !== 4) {
        result.textContent = 'Enter a 4-digit PIN';
        return;
      }
      result.textContent = 'Looking up...';
      dirBtn.classList.add('hidden');

      const res = await fetch('/lookup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pin})
      });
      const data = await res.json();
      if (!res.ok || !data.found) {
        result.textContent = 'PIN not found';
        return;
      }

      const addr = data.address;
      result.textContent = addr;
      lastAddress = addr;

      const geoRes = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(addr)}&key={{ google_api_key }}`);
      const geoData = await geoRes.json();
      if (geoData.results && geoData.results.length > 0) {
        const { lat, lng } = geoData.results[0].geometry.location;
        map.setCenter({ lat, lng });
        map.setZoom(15);
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: { lat, lng }, map });
        lastCoords = { lat, lng };
        dirBtn.classList.remove('hidden');
      }
    };

    // --- Directions ---
    dirBtn.onclick = () => {
      if (!lastCoords) return;
      let gmapsUrl;
      if (currentPos) {
        gmapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${currentPos.lat},${currentPos.lng}&destination=${encodeURIComponent(lastAddress)}`;
      } else {
        gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lastAddress)}`;
      }
      window.open(gmapsUrl, '_blank');
    };

    // --- Dynamic map resizing ---
    function adjustMapHeight() {
      const bottomPanel = document.querySelector('.bottom-panel');
      const mapEl = document.getElementById('map');
      const windowHeight = window.innerHeight;

      const newBottomHeight = Math.min(0.5 * windowHeight, bottomPanel.scrollHeight);
      bottomPanel.style.height = newBottomHeight + 'px';
      mapEl.style.height = (windowHeight - newBottomHeight) + 'px';
    }
    window.addEventListener('resize', adjustMapHeight);
    adjustMapHeight();

    // --- Service Worker ---
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/static/service-worker.js")
        .then(() => console.log("âœ… Service Worker registered"))
        .catch(err => console.error("SW registration failed", err));
    }
  </script>
</body>
</html>
