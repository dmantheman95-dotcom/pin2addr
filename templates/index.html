<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PIN Lookup</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div class="container">
    <h1>Enter 4-Digit PIN</h1>
    <div id="display">----</div>
    <div id="keypad"></div>
    <button id="submit">Submit</button>
    <div id="result"></div>
    <div id="map"></div>
  </div>

  <script>
    const display = document.getElementById('display');
    const keypad = document.getElementById('keypad');
    const result = document.getElementById('result');
    const submitBtn = document.getElementById('submit');

    const keys = ['1','2','3','4','5','6','7','8','9','0','C'];
    keys.forEach(k => {
      const btn = document.createElement('button');
      btn.textContent = k;
      btn.onclick = () => {
        if (k === 'C') display.textContent = '----';
        else if (display.textContent.replace(/-/g,'').length < 4)
          display.textContent = (display.textContent + k).replace(/-/g,'').slice(-4).padStart(4,'-');
      };
      keypad.appendChild(btn);
    });

    submitBtn.onclick = async () => {
      const pin = display.textContent.replace(/-/g,'');
      if (pin.length !== 4) {
        result.textContent = 'Enter a 4-digit PIN';
        return;
      }
      result.textContent = 'Looking up...';
      const res = await fetch('/lookup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pin})
      });
      const data = await res.json();
      if (!res.ok || !data.found) {
        result.textContent = 'PIN not found';
        return;
      }
      const addr = data.address;
      result.textContent = addr;

      // Show on map
      const mapDiv = document.getElementById('map');
      mapDiv.style.display = 'block';
      if (!window.map) {
        window.map = L.map('map').setView([43.7, -79.4], 10); // fallback: Toronto
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(window.map);
      }

      // Geocode via free API
      const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
      const loc = await geo.json();
      if (loc.length > 0) {
        const { lat, lon } = loc[0];
        window.map.setView([lat, lon], 15);
        L.marker([lat, lon]).addTo(window.map).bindPopup(addr).openPopup();
      }
    };
  </script>
</body>
</html>
